<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice {{ invoice.invoice_id }} | Device {{ invoice.device_id }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { margin: 0; padding: 0; }
            .container { max-width: 100% !important; }
            .pdf-content { 
                margin: 0 !important; 
                padding: 10px !important; 
                box-shadow: none !important;
            }
            .table { 
                font-size: 10px !important; 
                margin-bottom: 10px !important;
            }
            .table th, .table td { 
                padding: 4px !important; 
            }
            .invoice-font { 
                font-size: 10px !important; 
            }
            .invoice-header { 
                font-size: 14px !important; 
                margin: 10px 0 !important;
            }
        }
        
        .invoice-font {
            font-size: 12px;
            font-family: Arial, sans-serif;
        }
        
        .pdf-content {
            background: white;
            padding: 20px;
            margin: 20px 0;
        }
        
        .verification-code {
            font-family: monospace;
            font-weight: bold;
            color: #333;
        }
        
        .qr-code {
            text-align: center;
        }
        
        .qr-code img {
            max-width: 100px;
            height: auto;
        }
        
        .table th {
            background-color: #f8f9fa;
            font-weight: bold;
            border: 1px solid #dee2e6;
        }
        
        .table td, .table th {
            padding: 8px;
            border: 1px solid #dee2e6;
        }
        
        .text-end {
            text-align: right;
        }
        
        .text-center {
            text-align: center;
        }
        
        .seller-buyer-section {
            margin: 20px 0;
        }
        
        .receipt-info-section {
            margin: 15px 0;
        }
        
        .total-row {
            font-weight: bold;
            background-color: #f8f9fa;
        }
        
        .invoice-header {
            text-align: center;
            font-weight: bold;
            font-size: 18px;
            margin: 20px 0;
        }
        
        .breadcrumb {
            background-color: transparent;
            padding: 0;
            margin-bottom: 20px;
        }
        
        .breadcrumb-item + .breadcrumb-item::before {
            content: ">";
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Navigation and Header (Hidden on Print) -->
        <div class="no-print">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/">Home</a></li>
                    <li class="breadcrumb-item"><a href="/invoices-ui">Invoices</a></li>
                    <li class="breadcrumb-item active">Invoice {{ invoice.invoice_id }} | Device {{ invoice.device_id }}</li>
                </ol>
            </nav>
            
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h1>Invoice {{ invoice.invoice_id }} | Device {{ invoice.device_id }}</h1>
                <div class="btn-group" role="group">
                    <button id="pdfInvoice" class="btn btn-primary">
                        <i class="bi bi-filetype-pdf me-1"></i>Download PDF
                    </button>
                    <button id="printInvoice" class="btn btn-secondary">
                        <i class="bi bi-printer me-1"></i>Print
                    </button>
                </div>
            </div>
        </div>

        <!-- Invoice Content -->
        <div id="print_invoiceA4" class="pdf-content">
            <!-- Header Section -->
            <div class="row invoice-font">
                <div class="col-md-6">
                    <!-- Company Logo -->
                    <img src="/api/static_files/img/git_app_icon.png" alt="Company Logo" style="height: 100px; width: auto;">
                </div>
                <div class="col-md-4">
                    <p>Verification code: <span class="verification-code">{{ invoice.verification_number or '-' }}</span></p>
                    <p>You can verify this receipt manually at: {{ invoice.qr_code_string or '-' }}</p>
                </div>
                <div class="col-md-2 qr-code">
                    {% if invoice.qr_code_string %}
                    <img src="data:image/png;base64,{{ qr_code_image }}" alt="QR Code" style="height: 100px; width: auto;">
                    {% else %}
                    <p>QR Code here</p>
                    {% endif %}
                </div>
            </div>
            <hr>
            
            <!-- Invoice Type Header -->
            <div class="row mb-3 text-center">
                <div class="col-12">
                    {% if 'debit' in invoice.receipt_type.lower() %}
                    <h6 class="invoice-header">DEBIT NOTE</h6>
                    {% elif 'credit' in invoice.receipt_type.lower() %}
                    <h6 class="invoice-header">CREDIT NOTE</h6>
                    {% else %}
                    <h6 class="invoice-header">FISCAL TAX INVOICE</h6>
                    {% endif %}
                </div>
            </div>
            <hr>
            
            <!-- Seller/Buyer Section -->
            <div class="row invoice-font seller-buyer-section">
                <div class="col-md-6">
                    <h6><strong>SELLER</strong></h6>
                    <p>{{ invoice.tax_payer_name or '-' }}</p>
                    <p>TIN: {{ invoice.tax_payer_tin or '-' }}</p>
                    {% if invoice.vat_number %}
                    <p>VAT No: {{ invoice.vat_number }}</p>
                    {% endif %}
                    <p>{{ invoice.device_branch_name or '-' }}</p>
                    {% if branch_address %}
                    <p>{{ branch_address.street }}, {{ branch_address.house_no }}, {{ branch_address.city }}, {{ branch_address.province }}</p>
                    {% endif %}
                    {% if branch_contact %}
                    <p>Email: {{ branch_contact.email or '-' }}</p>
                    <p>Phone: {{ branch_contact.phone_number or '-' }}</p>
                    {% endif %}
                </div>
                <div class="col-md-6">
                    <h6><strong>BUYER</strong></h6>
                    <p>ZimHope Griffin IT Solutions</p>
                    <p>TIN: 2000393086</p>
                    <p>VAT No: 220247849</p>
                    <p>Livingstone Avenues, 91, HARARE, HARARE</p>
                    <p>Email: sales@zimhope.co.zw</p>
                    <p>Phone: 077238852</p>
                </div>
            </div>
            <hr>
            
            <!-- Receipt Information Section -->
            <div class="row invoice-font receipt-info-section">
                <div class="col-md-6">
                    <p>Receipt No: {{ invoice.receipt_counter }}/{{ invoice.receipt_global_no }}</p>
                    <p>Invoice No: {{ invoice.zimra_receipt_number }}</p>
                    <p>Device Serial No: {{ invoice.device_id }}</p>
                </div>
                <div class="col-md-6">
                    <p>Fiscal day No: {{ invoice.fiscal_day_number }}</p>
                    <p>Date: {{ invoice.created_at }}</p>
                    <p>Fiscal device ID: {{ invoice.device_id }}</p>
                </div>
            </div>
            
            <!-- Credit/Debit Note Reference (if applicable) -->
            {% if invoice.debit_credit_note_invoice_ref_date %}
            <hr>
            <div class="row mb-3 text-center">
                <div class="col-12">
                    {% if 'debit' in invoice.receipt_type.lower() %}
                    <h6 class="invoice-header">DEBITED INVOICE</h6>
                    {% else %}
                    <h6 class="invoice-header">CREDITED INVOICE</h6>
                    {% endif %}
                </div>
            </div>
            <div class="row invoice-font receipt-info-section">
                <div class="col-md-6">
                    <p>Receipt No: {{ invoice.receipt_counter }}</p>
                    <p>Invoice No: {{ invoice.zimra_receipt_number }}</p>
                    <p>Device Serial No: {{ invoice.device_id }}</p>
                </div>
                <div class="col-md-6">
                    <p>Date: {{ invoice.debit_credit_note_invoice_ref_date }}</p>
                </div>
            </div>
            {% endif %}
            <hr>
            
            <!-- Line Items Table -->
            <table class="table table-hover invoice-font">
                <thead>
                    <tr>
                        <th scope="col">Code</th>
                        <th scope="col">Description</th>
                        <th scope="col" class="text-end">Qty</th>
                        <th scope="col" class="text-end">Price</th>
                        <th scope="col" class="text-end">VAT</th>
                        <th scope="col" class="text-end">Amount (excl. tax)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for line_item in line_items %}
                    <tr>
                        <td>{{ line_item.receipt_line_hs_code or '-' }}</td>
                        <td>{{ line_item.receipt_line_name|title }}</td>
                        <td class="text-end">{{ line_item.receipt_line_quantity }}</td>
                        <td class="text-end">{{ "%.2f"|format(line_item.receipt_line_price) }}</td>
                        <td class="text-end">{{ line_item.tax_code }} {{ line_item.tax_percent }}%</td>
                        <td class="text-end">{{ "%.2f"|format(line_item.receipt_line_total) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr class="total-row">
                        <td colspan="5" class="text-end"><strong>Total</strong></td>
                        <td class="text-end"><strong>{{ "%.2f"|format(invoice.receipt_total) }}</strong></td>
                    </tr>
                    {% for tax_summary in tax_summaries %}
                    <tr>
                        <td colspan="4" class="text-end">{{ tax_summary.label }}</td>
                        <td class="text-end">{{ "%.2f"|format(tax_summary.amount) }}</td>
                        <td class="text-end">{{ "%.2f"|format(tax_summary.vat_amount) }}</td>
                    </tr>
                    {% endfor %}
                    <tr class="total-row">
                        <td colspan="5" class="text-end"><strong>Invoice total ({{ invoice.receipt_currency }})</strong></td>
                        <td class="text-end"><strong>{{ "%.2f"|format(invoice.receipt_total) }}</strong></td>
                    </tr>
                </tfoot>
            </table>
            
            <!-- Notes Section -->
            {% if invoice.notes %}
            <div class="row mb-3 text-center">
                <div class="col-12">
                    <p>{{ invoice.notes }}</p>
                </div>
            </div>
            {% endif %}
            
            <!-- Receipt Notes for Credit/Debit Notes -->
            {% if 'debit' in invoice.receipt_type.lower() or 'credit' in invoice.receipt_type.lower() %}
            {% if invoice.receipt_notes %}
            <div class="row mb-3">
                <div class="col-12">
                    <div class="border-top pt-3">
                        <h6 class="text-center mb-2"><strong>RECEIPT NOTES</strong></h6>
                        <div class="row invoice-font">
                            <div class="col-12">
                                <p class="text-center">{{ invoice.receipt_notes }}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
            {% endif %}
        </div>
        
        <!-- Back Button (Hidden on Print) -->
        <div class="no-print">
            <div class="d-flex justify-content-end mt-3">
                <a href="/invoices-ui" class="btn btn-primary">
                    <i class="bi bi-arrow-left-short"></i> Back
                </a>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // PDF Download functionality
        document.getElementById('pdfInvoice').addEventListener('click', function() {
            const invoiceId = '{{ invoice.invoice_id }}';
            const downloadUrl = `/api/invoices/${invoiceId}/pdf`;
            
            // Show loading state
            const button = document.getElementById('pdfInvoice');
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Generating PDF...';
            button.disabled = true;
            
            // Create a temporary link to trigger download
            const link = document.createElement('a');
            link.href = downloadUrl;
            link.download = `invoice_${invoiceId}_${new Date().toISOString().slice(0,19).replace(/:/g, '-')}.pdf`;
            link.target = '_blank';
            
            // Trigger download
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Reset button after a short delay
            setTimeout(() => {
                button.innerHTML = originalText;
                button.disabled = false;
            }, 2000);
        });
        
        // Print functionality
        document.getElementById('printInvoice').addEventListener('click', function() {
            window.print();
        });
        
        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'p') {
                e.preventDefault();
                window.print();
            }
        });
        
        // Add success/error feedback for PDF download
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            notification.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(notification);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }
    </script>
</body>
</html> 